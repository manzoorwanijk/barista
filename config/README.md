# Development configuration

This `/config` directory contains the development and build tools and their configuration files. It is more or less the ejected [Create React App (CRA)](https://create-react-app.dev/), with some minor changes to fit our needs.

## Why do we use an ejected CRA?

CRA supports a single Webpack entrypoint for Single Page Apps. At Event Espresso, we build interfaces for different areas of a website, so single page apps do not work for us. Thus, in order to use the best possible build setup (CRA), we need to use an ejected CRA to be able to modify the configuration to support multiple entry points.

## Our requirements

At Event Espresso, we have the core plugin as well as its supporting addons along with the SaaS platform. We build the interfaces for all of them in this repository. Thus, we need to maintain the assets for all of the plugins/addons separately. To increase the code reusability and avoid duplication, we use [Yarn Workspaces](https://classic.yarnpkg.com/en/docs/workspaces/) to create a package architecture in which we put the reusable code into different packages inside `/packages` directory. For different use cases, we use the word "domain" and each domain goes to its corresponding directory inside `/domains` directory.

Now to be truly reusable, we need to bundle these packages as standalone assets which can be bundled with any addon that needs them.
We mostly bundle common packages into the core plugin and make other addons dependent upon those packages.
We have some addons which have specific package(s) that is/are used only by that addon. We bundle that package with that addon domain. For example, [`rrule-generator`](../packages/rrule-generator/README.md) package is use only by Recurring Events Manager addon/domain, so we bundle it with that addon, instead of the core plugin.

In order to make all this work, we make some changes to the ejected CRA config.

## Significant changes to ejected CRA

Here are a few changes we make to the ejected CRA config.

-   ### Multiple entrypoints

    In order to build/develop the domains and packages, we add them as separate entrypoints to webpack. This is done by adding `entry` property to the [`paths.js`](./paths.js) file. The entries are generated by calling `getIncludedPathsAndEntries` from [`packages-and-domains.js`](./packages-and-domains.js). The `paths.entry` is then passed to Webpack as `entry` prop.

-   ### Included paths

    Since webpack loaders (like Babel, ESLint, ts-loader etc.) require limited paths to watch for transformation, we need so specify all the paths in `include` option to `babel-loader`, which is done by generating `paths.includePaths` using the same above function.<br />
    **Note:** We also have some global types in [/types/global.ts](../types/global.ts). These types should also be added to the inlcuded paths in order to transform TS.

-   ### Changes to Webpack ManifestPlugin

    In order to create an appropriate `asset-manifest.json` file which contains the information about the bundled assets, we need to make changes to its configuration. The change is just to override single entrypoint configuration with multiple entrypoints.

-   ### Changes to Webpack `output`
    -   `filename` option is changed to make each output file distinct by adding he entrypoint name to the file. For example `'static/js/[name].bundle.js'`, where `[name]` is the entrypoint name.
    -   `globalObject` and `libraryTarget` is set to `this` to load the packages externally as separate bundles.
    -   `library` is set to `['eventespresso', '[name]']`, mainly for the blocks domain to load the packages externally inside Block Editor.

## Dependency Extraction

As mentioned above, we use Yarn Workspaces to create packages and then `import` them elsewhere, but at the same time, we need to be able to load them externally instead of bundling with the consumer package/domain. To achieve that, we use [`@wordpress/dependency-extraction-webpack-plugin`](https://www.npmjs.com/package/@wordpress/dependency-extraction-webpack-plugin) package to extract the package dependencies to the assets.php files in webpack output. Those assets.php files are then used to determine the correct dependencies for each package and domain. The `DependencyExtractionWebpackPlugin` accepts two functions to configure the extraction - `requestToExternal` and `requestToHandle` which are defined in [`utils.js`](./utils.js).

## I18n string extraction

We use [`@wordpress/i18n`](https://www.npmjs.com/package/@wordpress/i18n) for translating the strings inside UI components. To collect al the strings and make them translation ready, we use [`@wordpress/babel-plugin-makepot`](https://www.npmjs.com/package/@wordpress/babel-plugin-makepot) package inside [`babel.config.js`](../babel.config.js) to create a POT file from production builds. This POT file, along with the JS and CSS assets gets deployed to the target domain where it is used for translations.

## Jest

We use `jest` for both unit and e2e testing. In e2e it's scope is being limited to the purpose of test runner, the rest is handled by `playwright`.
